{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard | KrisPC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        .card-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .card-gradient-3 { background: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%); }
        .card-gradient-4 { background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Nav -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-indigo-600 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-800">Analytics Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">Last 30 Days</span>
                    <a href="/admin/" class="text-sm font-medium text-gray-600 hover:text-indigo-600">
                        <i class="fas fa-arrow-left mr-1"></i> Back to Admin
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Visits -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Total Visits</p>
                        <h3 class="text-3xl font-bold text-gray-800">{{ summary.total_visits }}</h3>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-green-500 font-medium flex items-center">
                        <i class="fas fa-user-check mr-1"></i> {{ summary.unique_visitors }}
                    </span>
                    <span class="text-gray-400 ml-2">unique visitors</span>
                </div>
            </div>

            <!-- Avg Time -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Avg Time on Page</p>
                        <h3 class="text-3xl font-bold text-gray-800">{{ summary.avg_time }}s</h3>
                    </div>
                    <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                </div>
                 <div class="mt-4 flex items-center text-sm">
                    <span class="text-gray-400">Engagement Metric</span>
                </div>
            </div>

            <!-- Rage Clicks -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Rage Clicks</p>
                        <h3 class="text-3xl font-bold text-gray-800">{{ summary.rage_clicks }}</h3>
                    </div>
                    <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                        <i class="fas fa-mouse-pointer text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    {% if summary.rage_clicks > 0 %}
                    <span class="text-red-500 font-medium">Attention needed</span>
                    {% else %}
                    <span class="text-green-500 font-medium">All good</span>
                    {% endif %}
                </div>
            </div>

            <!-- Errors -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">Errors</p>
                        <h3 class="text-3xl font-bold text-gray-800">{{ summary.total_errors }}</h3>
                    </div>
                    <div class="p-2 bg-red-50 rounded-lg text-red-600">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                </div>
                 <div class="mt-4 flex items-center text-sm">
                    <span class="text-gray-400">Client-side errors</span>
                </div>
            </div>
        </div>

        <!-- Main Chart: Traffic -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-8">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Traffic Overview</h2>
            <div class="relative h-80">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>

        <!-- Secondary Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Devices -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Device Breakdown</h2>
                <div class="relative h-64">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>

            <!-- Browsers -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Top Browsers</h2>
                <div class="relative h-64">
                    <canvas id="browserChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 gap-8 mb-8">
            <!-- Locations Map -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 col-span-1 lg:col-span-2">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Live Traffic Map</h2>
                <div id="map" class="w-full h-96 rounded-lg"></div>
            </div>

            <!-- Locations Table -->
             <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 col-span-1 lg:col-span-2">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Recent Unique Locations</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Postal / Coordinates</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ISP / Org</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm">
                            {% for visit in unique_ip_locations %}
                            <tr>
                                <td class="px-6 py-4 font-mono text-xs text-indigo-600 max-w-xs break-words whitespace-normal">
                                    {{ visit.ip_address }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ visit.visit_count }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
                                        <div>
                                            <div class="font-medium text-gray-900">{{ visit.city|default:"Unknown City" }}</div>
                                            <div class="text-gray-500 text-xs">{{ visit.region|default:"" }}, {{ visit.country|default:"Unknown" }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">
                                    <div>{{ visit.postal_code|default:"-" }}</div>
                                    <div class="text-xs font-mono text-gray-400">
                                        {{ visit.latitude|default:"0.0" }}, {{ visit.longitude|default:"0.0" }}
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-gray-900">{{ visit.isp|default:"-" }}</div>
                                    <div class="text-xs text-gray-500">{{ visit.organization|default:"" }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">
                                    <div>{{ visit.network_type|default:"-" }}</div>
                                    <div class="text-xs">{{ visit.timezone|default:"UTC" }}</div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500 italic">
                                    No location data available yet.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Web Vitals -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Core Web Vitals (Avg)</h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <div class="group relative inline-block cursor-help">
                                <span class="text-gray-600 border-b border-dotted border-gray-400">LCP (Loading)</span>
                                <div class="invisible group-hover:visible absolute z-10 w-64 p-3 -mt-2 text-xs text-white bg-gray-800 rounded shadow-lg bottom-full mb-1 left-0">
                                    <p class="font-bold mb-1">Largest Contentful Paint</p>
                                    <p>Time to render the largest text or image.</p>
                                    <div class="mt-2 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-400"></span> Good: &lt; 2.5s
                                    </div>
                                </div>
                            </div>
                            <span class="font-bold {% if cwv.avg_lcp < 2500 %}text-green-500{% elif cwv.avg_lcp < 4000 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ cwv.avg_lcp }} ms</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <div class="group relative inline-block cursor-help">
                                <span class="text-gray-600 border-b border-dotted border-gray-400">CLS (Stability)</span>
                                <div class="invisible group-hover:visible absolute z-10 w-64 p-3 -mt-2 text-xs text-white bg-gray-800 rounded shadow-lg bottom-full mb-1 left-0">
                                    <p class="font-bold mb-1">Cumulative Layout Shift</p>
                                    <p>Measures visual stability (unexpected movement).</p>
                                    <div class="mt-2 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-400"></span> Good: &lt; 0.1
                                    </div>
                                </div>
                            </div>
                            <span class="font-bold {% if cwv.avg_cls < 0.1 %}text-green-500{% elif cwv.avg_cls < 0.25 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ cwv.avg_cls }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <div class="group relative inline-block cursor-help">
                                <span class="text-gray-600 border-b border-dotted border-gray-400">TTFB (Server Speed)</span>
                                <div class="invisible group-hover:visible absolute z-10 w-64 p-3 -mt-2 text-xs text-white bg-gray-800 rounded shadow-lg bottom-full mb-1 left-0">
                                    <p class="font-bold mb-1">Time to First Byte</p>
                                    <p>Server response time (network + backend processing).</p>
                                    <div class="mt-2 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-400"></span> Good: &lt; 0.8s
                                    </div>
                                </div>
                            </div>
                            <span class="font-bold text-gray-800">{{ cwv.avg_ttfb }} ms</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                     <div>
                        <div class="flex justify-between text-sm mb-1">
                            <div class="group relative inline-block cursor-help">
                                <span class="text-gray-600 border-b border-dotted border-gray-400">INP (Responsiveness)</span>
                                <div class="invisible group-hover:visible absolute z-10 w-64 p-3 -mt-2 text-xs text-white bg-gray-800 rounded shadow-lg bottom-full mb-1 left-0">
                                    <p class="font-bold mb-1">Interaction to Next Paint</p>
                                    <p>Latency of user interactions (clicks, taps, keys).</p>
                                    <div class="mt-2 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-400"></span> Good: &lt; 200ms
                                    </div>
                                </div>
                            </div>
                            <span class="font-bold text-gray-800">{{ cwv.avg_inp }} ms</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-4 text-center">Thresholds based on Google Web Vitals recommendations</p>
            </div>
        </div>

        <!-- Top Pages Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-bold text-gray-800">Top Visited Pages</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Path</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Time</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for page in top_pages %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ page.path }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ page.count }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ page.avg_time|default:"0" }}s</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">No data available yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // Data from Django
        const dates = {{ charts.dates|safe }};
        const dailyCounts = {{ charts.daily_counts|safe }};
        const deviceLabels = {{ charts.device_labels|safe }};
        const deviceData = {{ charts.device_data|safe }};
        const browserLabels = {{ charts.browser_labels|safe }};
        const browserData = {{ charts.browser_data|safe }};
        const countryLabels = {{ charts.country_labels|safe }};
        const countryData = {{ charts.country_data|safe }};

        // Common Chart Options
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#6b7280';
        
        // 1. Traffic Chart
        const ctxTraffic = document.getElementById('trafficChart').getContext('2d');
        const gradient = ctxTraffic.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); // Indigo
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

        new Chart(ctxTraffic, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Visits',
                    data: dailyCounts,
                    borderColor: '#6366f1',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [2, 4], color: '#f3f4f6' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // 2. Device Chart
        const ctxDevice = document.getElementById('deviceChart').getContext('2d');
        new Chart(ctxDevice, {
            type: 'doughnut',
            data: {
                labels: deviceLabels,
                datasets: [{
                    data: deviceData,
                    backgroundColor: [
                        '#6366f1', // Indigo
                        '#ec4899', // Pink
                        '#10b981', // Emerald
                        '#f59e0b'  // Amber
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // 3. Browser Chart
        const ctxBrowser = document.getElementById('browserChart').getContext('2d');
        new Chart(ctxBrowser, {
            type: 'pie',
            data: {
                labels: browserLabels,
                datasets: [{
                    data: browserData,
                    backgroundColor: [
                        '#3b82f6', // Blue
                        '#f97316', // Orange
                        '#8b5cf6', // Violet
                        '#ef4444', // Red
                        '#64748b'  // Slate
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // 5. Mapbox Map
        const mapToken = "{{ mapbox_token }}";
        const mapData = {{ map_data|safe }};

        if (mapToken && mapData.length > 0) {
            mapboxgl.accessToken = mapToken;
            
            // Determine center based on first point or default
            const initialCenter = mapData.length > 0 ? [mapData[0].lng, mapData[0].lat] : [0, 20];
            const initialZoom = mapData.length > 0 ? 3 : 1;

            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: initialCenter,
                zoom: initialZoom
            });

            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl());

            // Add markers
            mapData.forEach(point => {
                // Create custom marker element
                const el = document.createElement('div');
                el.className = 'marker';
                el.style.backgroundColor = '#6366f1';
                el.style.width = '24px';
                el.style.height = '24px';
                el.style.borderRadius = '50%';
                el.style.border = '2px solid white';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                el.style.cursor = 'pointer';
                
                // Add popup
                const popup = new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                        <div class="text-sm font-sans p-2">
                            <strong class="text-gray-900 block mb-1">${point.city}</strong>
                            <span class="text-gray-600">${point.count} visit(s)</span>
                        </div>
                    `);

                new mapboxgl.Marker(el)
                    .setLngLat([point.lng, point.lat])
                    .setPopup(popup)
                    .addTo(map);
            });
            
            // Adjust bounds to fit all markers if multiple
            if (mapData.length > 1) {
                const bounds = new mapboxgl.LngLatBounds();
                mapData.forEach(p => bounds.extend([p.lng, p.lat]));
                map.fitBounds(bounds, { padding: 50 });
            }
        } else if (!mapToken) {
            document.getElementById('map').innerHTML = `
                <div class="h-full w-full flex items-center justify-center bg-gray-100 rounded-lg text-gray-400">
                    <div class="text-center">
                        <i class="fas fa-map-marked-alt text-4xl mb-2"></i>
                        <p>Mapbox Token not configured</p>
                    </div>
                </div>
            `;
        } else {
             document.getElementById('map').innerHTML = `
                <div class="h-full w-full flex items-center justify-center bg-gray-100 rounded-lg text-gray-400">
                    <div class="text-center">
                        <i class="fas fa-globe-europe text-4xl mb-2"></i>
                        <p>No location data available yet</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
