{% extends "plexus/plexus_base.html" %}

{% block title %}System Admin - Second Brain{% endblock %}

{% block content %}
<div class="mb-4">
    <h1>System Administration</h1>
    <p class="text-muted">Monitor system health and manage intelligence providers.</p>
</div>

<div class="row g-4 mb-5">
    <!-- AI Provider Management -->
    <div class="col-md-6">
        <div class="card h-100 shadow-sm border-secondary">
            <div class="card-header bg-dark border-secondary">
                <h5 class="mb-0">ü™û Intelligence Provider</h5>
            </div>
            <div class="card-body">
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <label class="form-label">Active Provider</label>
                    <div class="input-group">
                        <select name="active_ai_provider" class="form-select bg-dark text-white border-secondary">
                            {% for code, name in config.AI_PROVIDERS %}
                                <option value="{{ code }}" {% if config.active_ai_provider == code %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">Switch Provider</button>
                    </div>
                </form>

                <h6>Current Usage (Estimated)</h6>
                
                <!-- Gemini Usage (Always show if data exists or if active) -->
                <div class="mb-3 {% if config.active_ai_provider == 'gemini' %}border-start border-info ps-2{% else %}opacity-50{% endif %}">
                    <div class="d-flex justify-content-between mb-1 small">
                        <span>Google Gemini {% if config.active_ai_provider == 'gemini' %}<span class="badge bg-info text-dark">Active</span>{% endif %}</span>
                        <span>{{ stats.usage.model_distribution.gemini|default:0 }} / 50 req</span>
                    </div>
                    <div class="progress bg-dark" style="height: 6px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {% widthratio stats.usage.model_distribution.gemini|default:0 50 100 %}%;"></div>
                    </div>
                </div>

                <!-- OpenAI Usage -->
                <div class="mb-3 {% if config.active_ai_provider == 'openai' %}border-start border-success ps-2{% else %}opacity-50{% endif %}">
                    <div class="d-flex justify-content-between mb-1 small">
                        <span>OpenAI {% if config.active_ai_provider == 'openai' %}<span class="badge bg-success text-dark">Active</span>{% endif %}</span>
                        <span>{{ stats.usage.model_distribution.openai|default:0 }} calls</span>
                    </div>
                    <div class="progress bg-dark" style="height: 6px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {% if config.active_ai_provider == 'openai' %}10{% else %}2{% endif %}%;"></div>
                    </div>
                </div>

                <!-- Anthropic Usage -->
                <div class="mb-3 {% if config.active_ai_provider == 'anthropic' %}border-start border-warning ps-2{% else %}opacity-50{% endif %}">
                    <div class="d-flex justify-content-between mb-1 small">
                        <span>Anthropic {% if config.active_ai_provider == 'anthropic' %}<span class="badge bg-warning text-dark">Active</span>{% endif %}</span>
                        <span>{{ stats.usage.model_distribution.anthropic|default:0 }} calls</span>
                    </div>
                    <div class="progress bg-dark" style="height: 6px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: {% if config.active_ai_provider == 'anthropic' %}10{% else %}2{% endif %}%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Infrastructure Status -->
    <div class="col-md-6">
        <div class="row g-4">
            <div class="col-12">
                <div class="card shadow-sm border-secondary">
                    <div class="card-body d-flex align-items-center">
                        <div class="flex-shrink-0 fs-1 me-3">üóÑÔ∏è</div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0">SQLite Database</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-success">{{ stats.db.status }}</span>
                                <small class="text-muted">{{ stats.db.name }} ({{ stats.db.size_kb }} KB)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card shadow-sm border-secondary">
                    <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0">‚ö° Redis Cache & Queue</h6>
                        <span class="badge bg-secondary">System Preference: {{ config.get_active_redis_env_display }}</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <!-- Local Redis -->
                            <div class="list-group-item bg-transparent border-secondary py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator me-3 {% if stats.redis.local.status == 'Online' %}text-success{% else %}text-danger{% endif %}" style="font-size: 1.5rem;">‚óè</div>
                                        <div>
                                            <h6 class="mb-0">Local Redis</h6>
                                            <small class="text-muted">
                                                {% if stats.redis.local.status == 'Online' %}
                                                    {{ stats.redis.local.keys }} keys | {{ stats.redis.local.memory_human }} mem
                                                {% else %}
                                                    <span title="{{ stats.redis.local.error }}">Offline - Check connection</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="active_redis_env" value="local">
                                        {% if config.active_redis_env == 'local' %}
                                            <button type="button" class="btn btn-sm btn-success disabled">Active</button>
                                        {% else %}
                                            <button type="submit" class="btn btn-sm btn-outline-primary">Use Local</button>
                                        {% endif %}
                                    </form>
                                </div>
                                {% if stats.redis.local.status != 'Online' %}
                                    <div class="mt-2 small text-muted border-top border-secondary pt-2" style="font-size: 0.75rem;">
                                        üí° Run <code>docker-compose up -d redis</code> to activate local instance.
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Cloud Redis -->
                            <div class="list-group-item bg-transparent border-secondary py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="status-indicator me-3 {% if stats.redis.cloud.status == 'Online' %}text-success{% elif stats.redis.cloud.status == 'Not Configured' %}text-muted{% else %}text-danger{% endif %}" style="font-size: 1.5rem;">‚óè</div>
                                        <div>
                                            <h6 class="mb-0">Cloud Redis (redis-cloud.com)</h6>
                                            <small class="text-muted">
                                                {% if stats.redis.cloud %}
                                                    {% if stats.redis.cloud.status == 'Online' %}
                                                        {{ stats.redis.cloud.keys }} keys | {{ stats.redis.cloud.memory_human }} mem
                                                    {% elif stats.redis.cloud.status == 'Not Configured' %}
                                                        Not configured via env vars
                                                    {% else %}
                                                        <span title="{{ stats.redis.cloud.error }}">Offline - Check credentials</span>
                                                    {% endif %}
                                                {% else %}
                                                    Same as local or not configured
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="active_redis_env" value="cloud">
                                        {% if config.active_redis_env == 'cloud' %}
                                            <button type="button" class="btn btn-sm btn-success disabled">Active</button>
                                        {% else %}
                                            <button type="submit" class="btn btn-sm btn-outline-primary" {% if stats.redis.cloud.status == 'Not Configured' %}disabled{% endif %}>Use Cloud</button>
                                        {% endif %}
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-secondary mb-5">
    <div class="card-header bg-dark border-secondary">
        <h5 class="mb-0">üìä Knowledge Statistics</h5>
    </div>
    <div class="card-body">
        <div class="row text-center g-4">
            <div class="col-md-4">
                <div class="p-3 border border-secondary rounded bg-dark-subtle">
                    <div class="fs-2 fw-bold text-primary">{{ stats.usage.total_inputs }}</div>
                    <div class="text-muted small uppercase">Raw Inputs</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border border-secondary rounded bg-dark-subtle">
                    <div class="fs-2 fw-bold text-info">{{ stats.usage.total_thoughts }}</div>
                    <div class="text-muted small uppercase">Structured Thoughts</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border border-secondary rounded bg-dark-subtle">
                    <div class="fs-2 fw-bold text-success">{{ stats.usage.total_actions }}</div>
                    <div class="text-muted small uppercase">Extracted Actions</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-secondary">
    <div class="card-header bg-dark border-secondary">
        <h5 class="mb-0">ü§ñ Model Attribution</h5>
    </div>
    <div class="list-group list-group-flush">
        {% for model, count in stats.usage.model_distribution.items %}
            <div class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center">
                <code>{{ model }}</code>
                <span class="badge bg-secondary rounded-pill">{{ count }}</span>
            </div>
        {% empty %}
            <div class="list-group-item bg-dark text-muted border-secondary italic">No data yet.</div>
        {% endfor %}
    </div>
</div>
{% endblock %}
