{% extends "plexus/plexus_base.html" %}
{% load i18n %}

{% block title %}{% trans "Kanban Board" %} - {% trans "Second Brain" %}{% endblock %}

{% block extra_css %}
<style>
    .kanban-item { cursor: grab; touch-action: none; }
    .kanban-item:active { cursor: grabbing; }
    .kanban-item.sortable-ghost { opacity: 0.5; background-color: #cbd5e1; }
    .dark .kanban-item.sortable-ghost { background-color: #334155; }
    .kanban-item.sortable-drag {
        opacity: 1;
        transform: rotate(2deg) scale(1.02);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 50;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{% trans "Action Kanban" %}</h1>
        <p class="text-gray-600 dark:text-slate-400 mt-1">{% trans "Manage and organize your tasks visually." %}</p>
    </div>
    <a href="{% url 'plexus:action_center' %}"
        class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-slate-200 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
        <span class="mr-2">ðŸ“‹</span> {% trans "List View" %}
    </a>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="flex flex-col h-full">
        <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-blue-500">
            <h3 class="font-semibold text-blue-600 dark:text-blue-400 uppercase tracking-wider text-sm">{% trans "To Do" %}</h3>
            <span class="bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-xs font-medium px-2.5 py-0.5 rounded-full">
                {{ columns.pending.count }}
            </span>
        </div>
        <div id="pending" class="kanban-col flex-1 bg-gray-100 dark:bg-slate-800/50 rounded-xl p-4 min-h-[500px] border border-gray-200 dark:border-slate-700" data-status="pending">
            {% for action in columns.pending %}
                {% include "plexus/partials/kanban_card.html" with action=action %}
            {% endfor %}
        </div>
    </div>

    <div class="flex flex-col h-full">
        <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-green-500">
            <h3 class="font-semibold text-green-600 dark:text-green-400 uppercase tracking-wider text-sm">{% trans "Done" %}</h3>
            <span class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 text-xs font-medium px-2.5 py-0.5 rounded-full">
                {{ columns.done.count }}
            </span>
        </div>
        <div id="done" class="kanban-col flex-1 bg-gray-100 dark:bg-slate-800/50 rounded-xl p-4 min-h-[500px] border border-gray-200 dark:border-slate-700" data-status="done">
            {% for action in columns.done %}
                {% include "plexus/partials/kanban_card.html" with action=action %}
            {% endfor %}
        </div>
    </div>

    <div class="flex flex-col h-full">
        <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-500">
            <h3 class="font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider text-sm">{% trans "Discarded" %}</h3>
            <span class="bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-gray-300 text-xs font-medium px-2.5 py-0.5 rounded-full">
                {{ columns.dismissed.count }}
            </span>
        </div>
        <div id="dismissed" class="kanban-col flex-1 bg-gray-100 dark:bg-slate-800/50 rounded-xl p-4 min-h-[500px] border border-gray-200 dark:border-slate-700" data-status="dismissed">
            {% for action in columns.dismissed %}
                {% include "plexus/partials/kanban_card.html" with action=action %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    const columns = ['pending', 'done', 'dismissed'];
    const csrfToken = '{{ csrf_token }}';

    columns.forEach(colId => {
        const el = document.getElementById(colId);
        if (el) {
            new Sortable(el, {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    if (evt.from !== evt.to) {
                        updateStatus(evt.item.dataset.id, evt.to.dataset.status);
                    }
                }
            });
        }
    });

    function updateStatus(id, status) {
        fetch(`/plexus/api/v1/actions/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => {
            if (!response.ok) alert('Failed to update status.');
        });
    }
</script>
{% endblock %}
