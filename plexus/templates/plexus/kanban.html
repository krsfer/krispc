{% extends "plexus/plexus_base.html" %}
{% load i18n %}

{% block title %}{% trans "Kanban Board" %} - {% trans "Second Brain" %}{% endblock %}

{% block extra_css %}
<style>
    .kanban-col {
        min-height: 500px;
        background-color: #2b3035; /* bg-dark-subtle equivalent but slightly distinct */
        border-radius: 0.5rem;
        padding: 1rem;
    }
    .kanban-item {
        cursor: grab;
        transition: transform 0.1s, box-shadow 0.1s;
    }
    .kanban-item:active {
        cursor: grabbing;
    }
    .kanban-item.sortable-ghost {
        opacity: 0.4;
        background-color: #495057;
    }
    .kanban-item.sortable-drag {
        opacity: 1;
        transform: scale(1.02);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
    }
    .col-header {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid;
    }
    .col-header-pending { border-color: #0d6efd; color: #0d6efd; }
    .col-header-done { border-color: #198754; color: #198754; }
    .col-header-dismissed { border-color: #6c757d; color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{% trans "Action Kanban" %}</h1>
    <a href="{% url 'plexus:action_center' %}" class="btn btn-outline-secondary">{% trans "List View" %}</a>
</div>

<div class="row g-4">
    <!-- Pending Column -->
    <div class="col-md-4">
        <div class="col-header col-header-pending">
            {% trans "To Do" %} <span class="badge bg-primary rounded-pill float-end">{{ columns.pending.count }}</span>
        </div>
        <div id="pending" class="kanban-col" data-status="pending">
            {% for action in columns.pending %}
                {% include "plexus/partials/kanban_card.html" with action=action %}
            {% endfor %}
        </div>
    </div>

    <!-- Done Column -->
    <div class="col-md-4">
        <div class="col-header col-header-done">
            {% trans "Done" %} <span class="badge bg-success rounded-pill float-end">{{ columns.done.count }}</span>
        </div>
        <div id="done" class="kanban-col" data-status="done">
            {% for action in columns.done %}
                {% include "plexus/partials/kanban_card.html" with action=action %}
            {% endfor %}
        </div>
    </div>

    <!-- Dismissed Column -->
    <div class="col-md-4">
        <div class="col-header col-header-dismissed">
            {% trans "Discarded" %} <span class="badge bg-secondary rounded-pill float-end">{{ columns.dismissed.count }}</span>
        </div>
        <div id="dismissed" class="kanban-col" data-status="dismissed">
            {% for action in columns.dismissed %}
                {% include "plexus/partials/kanban_card.html" with action=action %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    const columns = ['pending', 'done', 'dismissed'];
    const csrfToken = '{{ csrf_token }}';

    columns.forEach(colId => {
        new Sortable(document.getElementById(colId), {
            group: 'kanban', // set both lists to same group
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function (evt) {
                const itemEl = evt.item;
                const newStatus = evt.to.dataset.status;
                const actionId = itemEl.dataset.id;
                
                // Only update if status changed
                if (evt.from !== evt.to) {
                    updateStatus(actionId, newStatus);
                }
            }
        });
    });

    function updateStatus(id, status) {
        fetch(`/plexus/api/v1/actions/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => {
            if (!response.ok) {
                console.error('Update failed');
                // Ideally revert the DOM change here, but for simplicity we alert
                alert('Failed to update status. Please refresh.');
            }
        });
    }
</script>
{% endblock %}
