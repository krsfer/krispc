{% extends 'p2c_base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "JSON Ingest" %}{% endblock page_title %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <!-- PDF Upload Section -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">{% trans "Import PDF Schedule" %}</h2>
        <form id="pdf-upload-form" class="space-y-4" enctype="multipart/form-data">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Choose a PDF file" %}</label>
                <div class="mt-1 flex items-center space-x-2">
                    <div class="relative flex-grow">
                        <input type="text" id="file-name-display" readonly 
                               placeholder="{% trans 'No file chosen' %}"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-50 cursor-default">
                    </div>
                    <label for="pdf_file" class="flex-shrink-0 cursor-pointer py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        {% trans "Browse..." %}
                    </label>
                    <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" required class="sr-only">
                </div>
            </div>
            <script>
                document.getElementById('pdf_file').addEventListener('change', function(e) {
                    const fileName = e.target.files[0] ? e.target.files[0].name : '';
                    document.getElementById('file-name-display').value = fileName;
                });
            </script>
            <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                {% trans "Process PDF" %}
            </button>
        </form>
    </div>

    <div id="appointments-section" class="bg-white shadow-lg rounded-lg p-6 hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900" id="appointments-title">{% trans "Parsed Appointments" %}</h2>
            <button id="show-all-events" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors hidden">{% trans "Show All" %}</button>
        </div>
        <div class="mb-4 flex flex-col items-center">
            <div id="event-filters" class="flex flex-wrap gap-2 mb-2 justify-center"></div>
        </div>

        <!-- Calendar Sync Section -->
        <div id="calendar-sync-section" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">{% trans "Sync to Google Calendar" %}</h3>
                <button id="reapply-settings-btn" type="button"
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                    {% trans "Re-apply Caregiver Settings" %}
                </button>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <div class="flex-1">
                    <label for="calendar_name" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Calendar Name" %}</label>
                    <input type="text" id="calendar_name" name="calendar_name"
                           placeholder="{% trans "Enter calendar name (creates if doesn't exist)" %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-end">
                    <button id="sync-to-calendar-btn" type="button"
                            class="w-full sm:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        {% trans "Sync to Calendar" %}
                    </button>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">{% trans "This will delete all existing events for the month and create new ones. Events marked with «keep» will be preserved." %}</p>

            <!-- Progress bar section -->
            <div id="sync-progress-section" class="mt-4 hidden">
                <div class="mb-2 flex justify-between items-center">
                    <span id="sync-progress-description" class="text-sm text-gray-600">{% trans "Starting sync..." %}</span>
                    <span id="sync-progress-percent" class="text-sm font-semibold text-gray-900">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="sync-progress-bar" class="bg-blue-600 h-4 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="sync-result" class="mt-4 hidden"></div>
            </div>
            <div id="backup-link" class="mt-3 hidden">
                <div class="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-sm text-gray-700">{% trans "A backup was created before syncing." %}</span>
                    <a href="{% url 'backup_history' %}" class="text-sm text-blue-600 hover:text-blue-800 font-medium underline">{% trans "View Backup History" %}</a>
                </div>
            </div>
        </div>

        <div id="appointments-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Appointments will be injected here by JavaScript -->
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentAppointmentsData = null;

    // Initialize BroadcastChannel for cross-tab communication
    if ('BroadcastChannel' in window) {
        const settingsChannel = new BroadcastChannel('caregiver-settings-updates');

        settingsChannel.onmessage = async (event) => {
            if (event.data.type === 'settings-updated') {
                console.log('Caregiver settings updated in another tab, refreshing...');

                if (currentAppointmentsData && currentAppointmentsData.length > 0) {
                    const uniqueNames = [...new Set(
                        currentAppointmentsData.map(a => a.description?.split('(')[0].trim()).filter(Boolean)
                    )];
                    await fetchCaregiverSettings(uniqueNames);
                    applyDiminutives();
                    updateAppointmentColors();
                    initializeEventFiltersForPDF();
                }
            }
        };
    } else {
        console.warn('BroadcastChannel not supported - cross-tab updates disabled');
    }

    // Load data from localStorage on page load
    const storedData = localStorage.getItem('jsonIngestData');
    if (storedData) {
        const data = JSON.parse(storedData);
        currentAppointmentsData = data.appointments;
        displayAppointmentsFromPDF(data.appointments);
        if (data.suggested_calendar_name) {
            document.getElementById('calendar_name').value = data.suggested_calendar_name;
        }
    }
    
    // Store caregiver settings and colors (name -> settings/colorId) and color mapping (colorId -> hex)
    let caregiverSettings = {};  // Full settings including diminutive, Location, Tél, Description
    let caregiverColors = {};
    let colorIdToHex = {
        "1": "#ac725e",   // Brown (Cocoa)
        "2": "#33b679",   // Sage (Green)
        "3": "#8e24aa",   // Grape (Purple)
        "4": "#e67c73",   // Flamingo (Pink)
        "5": "#f6c026",   // Banana (Yellow)
        "6": "#f5511d",   // Tangerine (Orange)
        "7": "#039be5",   // Peacock (Blue)
        "8": "#616161",   // Graphite (Gray)
        "9": "#3f51b5",   // Blueberry (Dark Blue)
        "10": "#0b8043",  // Basil (Dark Green)
        "11": "#d60000"   // Tomato (Red)
    };

    // Get hex color for a caregiver name
    function getColorForCaregiver(name) {
        if (!name) return colorIdToHex["1"];
        const baseName = name.split('(')[0].trim();
        const colorId = caregiverColors[baseName] || caregiverColors[baseName.toUpperCase()] || "1";
        return colorIdToHex[colorId] || colorIdToHex["1"];
    }

    // Fetch caregiver settings from backend
    async function fetchCaregiverSettings(caregiverNames) {
        if (!caregiverNames || caregiverNames.length === 0) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch("{% url 'get_caregiver_settings' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ caregiver_names: caregiverNames })
            });

            if (response.ok) {
                const data = await response.json();
                caregiverSettings = data.settings;  // Store full settings
                caregiverColors = Object.fromEntries(Object.entries(data.settings).map(([name, setting]) => [name, setting.colorId]));
                console.log('Caregiver settings loaded:', caregiverSettings);
            }
        } catch (error) {
            console.error('Error fetching caregiver settings:', error);
        }
    }

    // Apply diminutives to appointment descriptions
    function applyDiminutives() {
        if (!currentAppointmentsData || currentAppointmentsData.length === 0) {
            return;
        }

        currentAppointmentsData.forEach(appointment => {
            const baseName = appointment.description.split('(')[0].trim();
            const setting = caregiverSettings[baseName];

            if (setting && setting.diminutive) {
                // Extract duration part: "NAME (02:30)" -> "(02:30)"
                const durationMatch = appointment.description.match(/\([\d:]+\)$/);
                const duration = durationMatch ? ' ' + durationMatch[0] : '';

                // Replace: "ARCHER, CHRISTOPHER (02:30)" -> "Chris (02:30)"
                appointment.description = setting.diminutive + duration;
            }
        });

        refreshAppointmentsDisplay();
    }

    const reapplyButton = document.getElementById('reapply-settings-btn');
    reapplyButton.addEventListener('click', async function() {
        if (!currentAppointmentsData || currentAppointmentsData.length === 0) {
            alert('{% trans "No appointments to apply settings to." %}');
            return;
        }
        const uniqueNames = [...new Set(currentAppointmentsData.map(a => a.description?.split('(')[0].trim()).filter(Boolean))];
        await fetchCaregiverSettings(uniqueNames);
        applyDiminutives();  // Apply diminutives to replace names
        updateAppointmentColors();
        initializeEventFiltersForPDF();
        alert('{% trans "Caregiver settings (including diminutives) have been applied." %}');
    });

    // Sync to Calendar button handler
    const syncButton = document.getElementById('sync-to-calendar-btn');
    syncButton.addEventListener('click', function() {
        const calendarName = document.getElementById('calendar_name').value.trim();
        if (!calendarName) {
            alert('{% trans "Please enter a calendar name" %}');
            return;
        }

        if (!currentAppointmentsData || currentAppointmentsData.length === 0) {
            alert('{% trans "No appointments to sync" %}');
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Show progress bar
        const progressSection = document.getElementById('sync-progress-section');
        progressSection.classList.remove('hidden');
        syncButton.disabled = true;
        syncButton.classList.add('opacity-50', 'cursor-not-allowed');

        fetch("{% url 'sync_pdf_to_calendar' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                calendar_name: calendarName,
                appointments: currentAppointmentsData,
                source: 'pdf'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showSyncError(data.error);
            } else if (data.task_id) {
                // Task launched successfully, start polling for progress
                pollSyncProgress(data.task_id);
            } else {
                showSyncError('{% trans "Unknown error: no task_id returned" %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showSyncError('{% trans "Failed to start sync: " %}' + error);
        });
    });

    // Sync progress polling
    let syncPollInterval = null;

    function pollSyncProgress(taskId) {
        syncPollInterval = setInterval(() => {
            fetch(`/celery-progress/task_status/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.complete) {
                        clearInterval(syncPollInterval);

                        if (data.success) {
                            showSyncSuccess(data.progress);
                        } else {
                            showSyncError(data.error || '{% trans "Sync failed" %}');
                        }
                    } else if (data.progress) {
                        // Update progress bar
                        const percent = data.progress.percent || 0;
                        const description = data.progress.description || '{% trans "Syncing..." %}';

                        document.getElementById('sync-progress-bar').style.width = `${percent}%`;
                        document.getElementById('sync-progress-percent').textContent = `${Math.round(percent)}%`;
                        document.getElementById('sync-progress-description').textContent = description;
                    }
                })
                .catch(error => {
                    clearInterval(syncPollInterval);
                    showSyncError('{% trans "Error checking progress: " %}' + error);
                });
        }, 500);
    }

    function showSyncSuccess(result) {
        const resultDiv = document.getElementById('sync-result');
        const message = result.message || '{% trans "Sync completed successfully" %}';
        const syncCompleteTitle = '{% trans "Sync Complete!" %}';
        const createdCountText = '{% trans "Created" %}';
        const deletedCountText = '{% trans "Deleted" %}';
        const eventsText = '{% trans "events" %}';
        const oldEventsText = '{% trans "old events" %}';

        resultDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-md';
        resultDiv.innerHTML = `
            <div class="flex items-start">
                <svg class="h-5 w-5 text-green-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="flex-1">
                    <h4 class="font-semibold text-green-900">${syncCompleteTitle}</h4>
                    <p class="text-sm text-green-800 mt-1">${message}</p>
                    ${result.created_count ? `<p class="text-xs text-green-700 mt-1">${createdCountText} ${result.created_count} ${eventsText}</p>` : ''}
                    ${result.deleted_count ? `<p class="text-xs text-green-700">${deletedCountText} ${result.deleted_count} ${oldEventsText}</p>` : ''}
                </div>
            </div>
        `;
        resultDiv.classList.remove('hidden');

        // Show backup link
        const backupLink = document.getElementById('backup-link');
        if (backupLink) {
            backupLink.classList.remove('hidden');
        }

        // Re-enable button
        const syncButton = document.getElementById('sync-to-calendar-btn');
        syncButton.disabled = false;
        syncButton.classList.remove('opacity-50', 'cursor-not-allowed');

        // Set progress to 100%
        document.getElementById('sync-progress-bar').style.width = '100%';
        document.getElementById('sync-progress-percent').textContent = '100%';
    }

    function showSyncError(errorMessage) {
        const resultDiv = document.getElementById('sync-result');
        const syncFailedTitle = '{% trans "Sync Failed" %}';

        resultDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-md';
        resultDiv.innerHTML = `
            <div class="flex items-start">
                <svg class="h-5 w-5 text-red-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <h4 class="font-semibold text-red-900">${syncFailedTitle}</h4>
                    <p class="text-sm text-red-800 mt-1">${errorMessage}</p>
                </div>
            </div>
        `;
        resultDiv.classList.remove('hidden');

        // Re-enable button
        const syncButton = document.getElementById('sync-to-calendar-btn');
        syncButton.disabled = false;
        syncButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    // PDF Upload form handler
    const pdfForm = document.getElementById('pdf-upload-form');
    pdfForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const fileInput = document.getElementById('pdf_file');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        if (!fileInput.files.length) {
            alert('{% trans "Please select a PDF file" %}');
            return;
        }

        const formData = new FormData();
        formData.append('pdf_file', fileInput.files[0]);

        fetch("{% url 'process_pdf_for_display' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('{% trans "Error: " %}' + data.error);
            } else {
                currentAppointmentsData = data.appointments;
                localStorage.setItem('jsonIngestData', JSON.stringify(data));
                displayAppointmentsFromPDF(data.appointments);

                // Prefill calendar name if suggested
                if (data.suggested_calendar_name) {
                    document.getElementById('calendar_name').value = data.suggested_calendar_name;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "An error occurred while processing the PDF." %}');
        });
    });

    // Display appointments from PDF
    async function displayAppointmentsFromPDF(appointments) {
        const appointmentsSection = document.getElementById('appointments-section');
        const appointmentsGrid = document.getElementById('appointments-grid');
        appointmentsGrid.innerHTML = '';

        if (appointments && appointments.length > 0) {
            // Extract unique caregiver names and fetch their colors
            const uniqueNames = [...new Set(appointments.map(a => a.description?.split('(')[0].trim()).filter(Boolean))];
            await fetchCaregiverSettings(uniqueNames);

            // Sort by day and start time
            appointments.sort((a, b) => {
                if (a.day !== b.day) return a.day - b.day;
                return a.start_time.localeCompare(b.start_time);
            });

            appointments.forEach((appointment, index) => {
                const appointmentElement = createAppointmentCard(appointment, index);
                appointmentsGrid.appendChild(appointmentElement);
            });
            appointmentsSection.classList.remove('hidden');

            // Initialize interactive features (colors are now loaded)
            initializeEventFiltersForPDF();
            updateAppointmentColors();
            updateTotalDuration();
            updateShowAllButton();
        } else {
            appointmentsSection.classList.add('hidden');
        }
    }

    // Apply colors to appointment cards
    function updateAppointmentColors() {
        const appointments = document.querySelectorAll('#appointments-grid > div');
        appointments.forEach(appointment => {
            const descText = appointment.querySelector('.description-text');
            const colorSquare = appointment.querySelector('.name-color-square');
            if (descText && colorSquare) {
                const name = descText.textContent.trim();
                const color = getColorForCaregiver(name);
                colorSquare.style.backgroundColor = color;
                colorSquare.style.display = 'inline-block';
                colorSquare.style.width = '12px';
                colorSquare.style.height = '12px';
                colorSquare.style.marginRight = '8px';
                colorSquare.style.borderRadius = '2px';
                colorSquare.style.verticalAlign = 'middle';

                // Also update the border color of the card
                appointment.style.borderLeftColor = color;
            }
        });
    }

    // Create an appointment card (view mode)
    function createAppointmentCard(appointment, index) {
        const day = appointment.day;
        const startTime = appointment.start_time;
        const endTime = appointment.end_time;
        const description = appointment.description;
        const durationMinutes = appointment.duration_minutes || 0;

        // Calculate duration string
        const durationHours = Math.floor(durationMinutes / 60);
        const durationMins = durationMinutes % 60;
        const durationStr = `${durationHours.toString().padStart(2, '0')}:${durationMins.toString().padStart(2, '0')}`;

        // Check if it's a weekend
        const month = appointment.month || new Date().getMonth() + 1;
        const year = appointment.year || new Date().getFullYear();
        const date = new Date(year, month - 1, day);
        const dayOfWeek = date.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const bgClass = isWeekend ? 'bg-gray-100' : 'bg-white';

        const dayText = '{% trans "Day" %}';
        const fromText = '{% trans "from" %}';
        const toText = '{% trans "to" %}';
        const clickToEditText = '{% trans "Click to edit" %}';
        const nameText = '{% trans "Name" %}';
        const startText = '{% trans "Start" %}';
        const endText = '{% trans "End" %}';
        const saveText = '{% trans "Save" %}';
        const cancelText = '{% trans "Cancel" %}';
        const deleteText = '{% trans "Delete" %}';

        const appointmentElement = document.createElement('div');
        appointmentElement.className = `border-l-4 border-indigo-500 pl-4 ${bgClass} rounded-lg shadow-sm p-3 cursor-pointer hover:shadow-md transition-shadow`;
        appointmentElement.dataset.index = index;
        appointmentElement.dataset.day = day;
        appointmentElement.dataset.start = startTime;
        appointmentElement.dataset.end = endTime;
        
        appointmentElement.innerHTML = `
            <div class="appointment-view">
                <p class="text-lg appointment-description">
                    <span class="name-color-square"></span>
                    <span class="description-text">${description}</span>
                </p>
                <p class="text-sm text-gray-600">
                    ${dayText} ${day} ${fromText} ${startTime} ${toText} ${endTime} • ${durationStr}
                </p>
                <p class="text-xs text-gray-400 mt-1">${clickToEditText}</p>
            </div>
            <div class="appointment-edit hidden">
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-600">${nameText}</label>
                        <input type="text" class="edit-description w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="${description}">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">${dayText}</label>
                            <input type="number" class="edit-day w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="${day}" min="1" max="31">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">${startText}</label>
                            <input type="time" class="edit-start w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="${startTime}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">${endText}</label>
                            <input type="time" class="edit-end w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="${endTime}">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="save-btn flex-1 px-2 py-1 text-xs bg-green-600 hover:bg-green-700 text-white rounded transition-colors">${saveText}</button>
                        <button type="button" class="cancel-btn flex-1 px-2 py-1 text-xs bg-gray-400 hover:bg-gray-500 text-white rounded transition-colors">${cancelText}</button>
                        <button type="button" class="delete-btn px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors">${deleteText}</button>
                    </div>
                </div>
            </div>
        `;

        // Add click handler for view mode
        const viewDiv = appointmentElement.querySelector('.appointment-view');
        const editDiv = appointmentElement.querySelector('.appointment-edit');

        viewDiv.addEventListener('click', (e) => {
            // Close any other open edit forms
            document.querySelectorAll('.appointment-edit:not(.hidden)').forEach(openEdit => {
                openEdit.classList.add('hidden');
                openEdit.previousElementSibling.classList.remove('hidden');
            });
            // Open this edit form
            viewDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');
            editDiv.querySelector('.edit-description').focus();
        });

        // Save button handler
        editDiv.querySelector('.save-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const idx = parseInt(appointmentElement.dataset.index);
            const newDescription = editDiv.querySelector('.edit-description').value.trim();
            const newDay = parseInt(editDiv.querySelector('.edit-day').value);
            const newStart = editDiv.querySelector('.edit-start').value;
            const newEnd = editDiv.querySelector('.edit-end').value;

            if (!newDescription || !newDay || !newStart || !newEnd) {
                alert('{% trans "Please fill in all fields" %}');
                return;
            }

            // Calculate new duration
            const [startH, startM] = newStart.split(':').map(Number);
            const [endH, endM] = newEnd.split(':').map(Number);
            let newDurationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
            if (newDurationMinutes < 0) newDurationMinutes += 24 * 60; // Overnight

            // Update data
            currentAppointmentsData[idx].description = newDescription;
            currentAppointmentsData[idx].day = newDay;
            currentAppointmentsData[idx].start_time = newStart;
            currentAppointmentsData[idx].end_time = newEnd;
            currentAppointmentsData[idx].duration_minutes = newDurationMinutes;

            // Refresh display
            refreshAppointmentsDisplay();
        });

        // Cancel button handler
        editDiv.querySelector('.cancel-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            viewDiv.classList.remove('hidden');
            editDiv.classList.add('hidden');
            // Reset values
            editDiv.querySelector('.edit-description').value = description;
            editDiv.querySelector('.edit-day').value = day;
            editDiv.querySelector('.edit-start').value = startTime;
            editDiv.querySelector('.edit-end').value = endTime;
        });

        // Delete button handler
        editDiv.querySelector('.delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('{% trans "Delete this appointment?" %}')) {
                const idx = parseInt(appointmentElement.dataset.index);
                currentAppointmentsData.splice(idx, 1);
                refreshAppointmentsDisplay();
            }
        });

        return appointmentElement;
    }

    // Refresh the appointments display after edit/delete
    async function refreshAppointmentsDisplay() {
        // Colors are already loaded, so this will be fast
        await displayAppointmentsFromPDF(currentAppointmentsData);
    }

    // Filter initialization for PDF appointments
    function initializeEventFiltersForPDF() {
        const appointments = Array.from(document.querySelectorAll('#appointments-grid > div'));
        const nameStats = new Map();

        appointments.forEach(appointment => {
            const descTextEl = appointment.querySelector('.description-text');
            if (!descTextEl) return;
            const fullName = descTextEl.textContent.trim();
            const baseName = fullName.split('(')[0].trim();

            if (!nameStats.has(baseName)) {
                nameStats.set(baseName, { count: 0, totalMinutes: 0 });
            }

            const stats = nameStats.get(baseName);
            stats.count++;

            // Use data attributes for robustness
            if (appointment.dataset.start && appointment.dataset.end) {
                const [startHour, startMin] = appointment.dataset.start.split(':').map(Number);
                const [endHour, endMin] = appointment.dataset.end.split(':').map(Number);

                let startMinutes = startHour * 60 + startMin;
                let endMinutes = endHour * 60 + endMin;
                if (endMinutes < startMinutes) {
                    endMinutes += 24 * 60;
                }
                stats.totalMinutes += endMinutes - startMinutes;
            }
        });

        const filterContainer = document.getElementById('event-filters');
        filterContainer.innerHTML = '';

        nameStats.forEach((stats, baseName) => {
            const hours = Math.floor(stats.totalMinutes / 60);
            const minutes = stats.totalMinutes % 60;
            const duration = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

            const avgMinutes = stats.count > 0 ? stats.totalMinutes / stats.count : 0;
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = Math.round(avgMinutes % 60);
            const avgDuration = `${avgHours.toString().padStart(2, '0')}:${avgMins.toString().padStart(2, '0')}`;

            const button = document.createElement('button');
            button.className = 'flex items-center gap-2 text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors';

            const colorSquare = document.createElement('span');
            colorSquare.className = 'inline-block w-3 h-3 rounded';
            colorSquare.style.backgroundColor = getColorForCaregiver(baseName);

            const text = document.createElement('span');
            text.textContent = `${baseName} (${duration}) (${stats.count}) (${avgDuration})`;

            button.appendChild(colorSquare);
            button.appendChild(text);

            button.addEventListener('click', () => filterAppointments(baseName));
            filterContainer.appendChild(button);
        });

        document.getElementById('show-all-events').addEventListener('click', () => filterAppointments(null));
    }

    function updateShowAllButton() {
        const appointments = document.querySelectorAll('#appointments-grid > div');
        const totalCount = appointments.length;
        const showAllButton = document.getElementById('show-all-events');
        const showAllText = '{% trans "Show All" %}';
        showAllButton.textContent = `${showAllText} ${totalCount}`;
    }

    function updateTotalDuration() {
        const visibleAppointments = Array.from(document.querySelectorAll('#appointments-grid > div')).filter(
            appointment => appointment.style.display !== 'none'
        );

        let totalMinutes = 0;
        visibleAppointments.forEach(appointment => {
            if (appointment.dataset.start && appointment.dataset.end) {
                const [startHour, startMin] = appointment.dataset.start.split(':').map(Number);
                const [endHour, endMin] = appointment.dataset.end.split(':').map(Number);

                let startMinutes = startHour * 60 + startMin;
                let endMinutes = endHour * 60 + endMin;
                if (endMinutes < startMinutes) {
                    endMinutes += 24 * 60;
                }
                totalMinutes += endMinutes - startMinutes;
            }
        });

        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const title = document.getElementById('appointments-title');
        const parsedAppointmentsText = '{% trans "Parsed Appointments" %}';
        title.innerHTML = `${parsedAppointmentsText} <span class="text-sm text-gray-600">(${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')})</span>`;
    }

    function filterAppointments(filterName) {
        const appointments = document.querySelectorAll('#appointments-grid > div');
        const showAllButton = document.getElementById('show-all-events');

        appointments.forEach(appointment => {
            const descTextEl = appointment.querySelector('.description-text');
            if (!descTextEl) return;
            const fullName = descTextEl.textContent.trim();
            const baseName = fullName.split('(')[0].trim();
            if (!filterName || baseName === filterName) {
                appointment.style.display = '';
            } else {
                appointment.style.display = 'none';
            }
        });

        updateTotalDuration();

        if (filterName) {
            showAllButton.classList.remove('hidden');
        } else {
            showAllButton.classList.add('hidden');
        }

        const filterButtons = document.querySelectorAll('#event-filters button');
        filterButtons.forEach(button => {
            const buttonText = button.querySelector('span:last-child').textContent;
            const buttonName = buttonText.split(' (')[0];
            if (buttonName === filterName) {
                button.classList.add('bg-gray-300');
                button.classList.remove('bg-gray-100');
            } else {
                button.classList.remove('bg-gray-300');
                button.classList.add('bg-gray-100');
            }
        });
    }
});
</script>
{% endblock extra_js %}