{% extends 'p2c_base.html' %}
{% load static %}
{% load custom_filters %}
{% load i18n %}

{% block page_title %}{% trans "Home" %}{% endblock page_title %}

{% block content %}
    {% if not user.is_authenticated %}
        <div class="text-center py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">{% trans "Welcome to PDF2Calendar" %}</h1>
            <p class="text-xl text-gray-600 mb-8">{% trans "Please sign in with Google to get started." %}</p>
            {% if google_oauth2_client_id %}
                <div id="google-signin-button" class="flex justify-center mt-4">
                    <button class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow flex items-center">
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-4 h-4 mr-2">
                        {% trans "Sign in with Google" %}
                    </button>
                </div>
                <div class="mt-12 text-sm text-gray-500">
                    {% if LANGUAGE_CODE == 'fr' %}
                    <a href="https://www.krispc.fr/privacy/" class="hover:text-gray-900 underline">{% trans "Privacy Policy" %}</a>
                    <span class="mx-2">·</span>
                    <a href="https://www.krispc.fr/terms/" class="hover:text-gray-900 underline">{% trans "Terms of Service" %}</a>
                    {% else %}
                    <a href="https://www.krispc.fr/en/privacy/" class="hover:text-gray-900 underline">{% trans "Privacy Policy" %}</a>
                    <span class="mx-2">·</span>
                    <a href="https://www.krispc.fr/en/terms/" class="hover:text-gray-900 underline">{% trans "Terms of Service" %}</a>
                    {% endif %}
                </div>
            {% else %}
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                    <p>{% trans "Google Sign-In is currently unavailable. Please try again later." %}</p>
                </div>
            {% endif %}
        </div>
    {% else %}
        <!-- Main container with natural page scroll (avoid collapsing the appointments section) -->
        <div class="flex flex-col min-h-screen" id="fixed-layout-container">
            <!-- Fixed header section -->
            <div class="bg-gray-100 flex-none">
                <div class="max-w-4xl mx-auto px-4 py-6">
                    <!-- Paste Text section -->
                    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">{% trans "Paste Schedule Text" %}</h2>
                        <form action="{% url 'process_pasted_text' %}" method="post" class="space-y-4">
                            {% csrf_token %}
                            <div>
                                <label for="schedule_text" class="block text-sm font-medium text-gray-700">{% trans "Paste text here" %}</label>
                                <textarea id="schedule_text" name="schedule_text" rows="6" required
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit"
                                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                {% trans "Process Text" %}
                            </button>
                        </form>
                    </div>

                    <!-- Upload section -->
                    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">
                            {% trans "Import PDF Schedule" %}
                            {% if uploaded_filename %}
                                <span class="text-base text-green-600 font-normal ml-2">{{ uploaded_filename }}</span>
                            {% else %}
                                <span class="text-base text-red-600 font-normal ml-2">...</span>
                            {% endif %}
                        </h2>
                        <form action="{% url 'upload_pdf' %}" method="post" enctype="multipart/form-data" class="space-y-4" id="upload-form">
                            {% csrf_token %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Choose a PDF file" %}</label>
                                <div class="mt-1 flex items-center space-x-2">
                                    <div class="relative flex-grow">
                                        <input type="text" id="file-name-display" readonly 
                                               placeholder="{% trans 'No file chosen' %}"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-50 cursor-default">
                                    </div>
                                    <label for="pdf_file" class="flex-shrink-0 cursor-pointer py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        {% trans "Browse..." %}
                                    </label>
                                    <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" required class="sr-only">
                                </div>
                            </div>
                            <script>
                                document.getElementById('pdf_file').addEventListener('change', function(e) {
                                    const fileName = e.target.files[0] ? e.target.files[0].name : '';
                                    document.getElementById('file-name-display').value = fileName;
                                });
                            </script>
                            <button type="submit"
                                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                {% trans "Import and Process" %}
                            </button>
                        </form>
                    </div>

                    <!-- Calendar selection -->
                    <div class="mb-4">
                        <label for="calendar-select" class="block text-sm font-medium text-gray-700">{% trans "Select Calendar" %}</label>
                        <div class="mt-1 relative">
                            <select id="calendar-select" name="calendar_id"
                                    data-fetch-url="{% url 'get_calendars' %}"
                                    data-create-url="{% url 'create_calendar' %}"
                                    data-save-url="{% url 'save_selected_calendar' %}"
                                    class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                                    onchange="updateCalendarIds(this.value)">
                                <option value="">{% trans "Select a calendar..." %}</option>
                            </select>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">{% trans "Choose the calendar where events will be created or deleted" %}</p>
                    </div>

                    <script>
                        // Initialize calendar selection when the DOM is loaded
                        document.addEventListener('DOMContentLoaded', function() {
                            console.log('DOM loaded, initializing calendar...');

                            // Add direct event listener to verify onchange
                            const calendarSelect = document.getElementById('calendar-select');
                            if (calendarSelect) {
                                calendarSelect.addEventListener('change', function(event) {
                                    console.log('Calendar selection changed to:', event.target.value);
                                });
                            }

                            fetchCalendars();
                        });
                    </script>

                    <!-- Action buttons -->
                    <div class="flex space-x-4">
                        {% if appointments %}
                            <!-- Flush form -->
                            <form id="flush-form" action="{% url 'flush_events' document_id=document_id|default:0 %}" method="post" class="flex-1">
                                {% csrf_token %}
                                <input type="hidden" name="calendar_id" id="flush-calendar-id">
                                <button type="button"
                                        onclick="handleCalendarOperation('flush', event)"
                                        class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    {% blocktrans %}Flush {{ current_month_name }} Events{% endblocktrans %}
                                </button>
                            </form>

                            <!-- Create events form -->
                            <form id="create-form" action="{% url 'create_events' document_id=document_id|default:0 %}" method="post" class="flex-1">
                                {% csrf_token %}
                                <input type="hidden" name="calendar_id" id="create-calendar-id">
                                <button type="button"
                                        onclick="handleCalendarOperation('create', event)"
                                        class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="create-button-text">{% blocktrans %}Create {{ current_month_name }} Calendar Events{% endblocktrans %}</span>
                                </button>
                            </form>
                        {% else %}
                            <div class="flex-1">
                                <button type="button"
                                        onclick="alert('{% trans "Please upload a PDF or paste text first" %}')"
                                        class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-400 cursor-not-allowed">
                                    {% trans "Flush Events" %}
                                </button>
                            </div>
                            <div class="flex-1">
                                <button type="button"
                                        onclick="alert('{% trans "Please upload a PDF or paste text first" %}')"
                                        class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-400 cursor-not-allowed">
                                    {% blocktrans %}Create {{ current_month_name }} Calendar Events{% endblocktrans %}
                                </button>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Unified Progress Container -->
                    {% include 'calendar_operations.html' %}

                </div>
            </div>

            <!-- Scrollable appointments section -->
            <div class="flex-1 overflow-auto bg-gray-50">
                <div class="max-w-6xl mx-auto px-4 py-6 scrollable-content">
                    <div class="bg-white shadow-lg rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900" id="appointments-title">
                                <span class="font-bold">
                                    {% trans "Pending Appointments" %}
                                </span> 
                                {% if current_month_name and current_year %}({{ current_month_name }} {{ current_year }}){% endif %}
                            </h2>
                            <button id="show-all-events" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors hidden">{% trans "Show All" %}</button>
                        </div>

                        {% if appointments and appointments|length > 0 %}
                            <!-- Time Gap Warnings Section -->
                            {% if gap_warnings %}
                                <style>
                                    /* Ensure all SVGs have proper max sizes */
                                    svg {
                                        max-width: 100%;
                                        max-height: 100%;
                                    }
                                    .warning-icon-small {
                                        width: 20px !important;
                                        height: 20px !important;
                                        max-width: 20px !important;
                                        max-height: 20px !important;
                                    }
                                    .warning-icon-tiny {
                                        width: 16px !important;
                                        height: 16px !important;
                                        max-width: 16px !important;
                                        max-height: 16px !important;
                                    }
                                </style>
                                <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 mr-2">
                                            <svg class="warning-icon-small text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-sm font-semibold text-yellow-800 mb-2">{% trans "Time Gap Warnings" %}</h3>
                                            <div class="text-sm text-yellow-700 space-y-1">
                                                {% for warning in gap_warnings %}
                                                    <div class="flex items-center">
                                                        <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded mr-2">{% trans "Day" %} {{ warning.first_appointment.day }}</span>
                                                        <span>{{ warning.warning_message }} {% trans "between" %} {{ warning.first_appointment.description|truncatechars:30 }} ({% trans "ends" %} {{ warning.first_appointment.end_time }}) {% trans "and" %} {{ warning.second_appointment.description|truncatechars:30 }} ({% trans "starts" %} {{ warning.second_appointment.start_time }})</span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="mb-4 flex flex-col items-center">
                                <div id="event-filters" class="flex flex-wrap gap-2 mb-2 justify-center"></div>
                            </div>

                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="appointments-grid">
                                {% for appointment in appointments %}
                                    {% with description=appointment.description|split:"\n"|first|trim %}
                                        {% if not "temps de pause repas"|lower in description|lower and not "pause"|lower in description|lower and not "repas"|lower in description|lower %}
                                            <div class="border-l-4 {% if appointment.has_gap_warning %}border-yellow-500{% else %}border-indigo-500{% endif %} pl-4 {% if appointment.day|is_weekend:current_month_year %}bg-gray-100{% else %}bg-white{% endif %} rounded-lg shadow-sm p-3"
                                                 data-day="{{ appointment.day }}"
                                                 data-start="{{ appointment.start_time }}"
                                                 data-end="{{ appointment.end_time }}">
                                                <p class="text-lg appointment-description">
                                                    <span class="name-color-square"></span>
                                                    <span class="description-text">{{ appointment.description }}</span>
                                                    {% if appointment.has_gap_warning %}
                                                        <svg class="warning-icon-tiny inline-block text-yellow-500 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" title="{% trans "Short time gap with another appointment" %}">
                                                            <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                                        </svg>
                                                    {% endif %}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    {% blocktrans with day=appointment.day start=appointment.start_time end=appointment.end_time %}Day {{ day }} from {{ start }} to {{ end }}{% endblocktrans %}
                                                    {% if appointment.duration_minutes %} • {{ appointment.duration_minutes|minutes_to_hhmm }}{% endif %}
                                                </p>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </div>

                            {{ event_settings|json_script:"event-settings-data" }}

                            <script>
                                // Function to safely parse event settings
                                function getEventSettings() {
                                    try {
                                        const settingsElement = document.getElementById('event-settings-data');
                                        if (!settingsElement) {
                                            console.error('Event settings element not found');
                                            return {};
                                        }
                                        return JSON.parse(settingsElement.textContent || '{}');
                                    } catch (error) {
                                        console.error('Error parsing event settings:', error);
                                        return {};
                                    }
                                }

                                const colorIdToHex = {
                                    "1": "#ac725e",  // Brown
                                    "2": "#33b679",  // Sage
                                    "3": "#8e24aa",  // Grape
                                    "4": "#e67c73",  // Flamingo
                                    "5": "#f6c026",  // Banana
                                    "6": "#f5511d",  // Tangerine
                                    "7": "#039be5",  // Peacock
                                    "8": "#616161",  // Graphite
                                    "9": "#3f51b5",  // Blueberry
                                    "10": "#0b8043", // Basil
                                    "11": "#d60000"  // Tomato
                                };

                                // Function to get color for a name from event settings
                                function getColorForName(name) {
                                    const eventSettings = getEventSettings();
                                    if (!name) return null;

                                    name = name.toUpperCase();
                                    for (const [settingName, setting] of Object.entries(eventSettings)) {
                                        if (name.includes(settingName.toUpperCase())) {
                                            return colorIdToHex[setting.colorId];
                                        }
                                    }
                                    // If no match found, try to match just the last name
                                    for (const [settingName, setting] of Object.entries(eventSettings)) {
                                        const lastName = settingName.split(',')[0].trim().toUpperCase();
                                        if (name.includes(lastName)) {
                                            return colorIdToHex[setting.colorId];
                                        }
                                    }
                                    // Use default color if no match found
                                    return eventSettings.DEFAULT ? colorIdToHex[eventSettings.DEFAULT.colorId] : null;
                                }

                                // Function to update appointment colors
                                function updateAppointmentColors() {
                                    const descriptions = document.querySelectorAll('.appointment-description');
                                    descriptions.forEach(desc => {
                                        const colorSquare = desc.querySelector('.name-color-square');
                                        const descText = desc.querySelector('.description-text');
                                        if (descText) {
                                            const name = descText.textContent?.trim();
                                            const color = getColorForName(name);
                                            if (color) {
                                                // Update the color square
                                                if (colorSquare) {
                                                    colorSquare.style.backgroundColor = color;
                                                    colorSquare.style.display = 'inline-block';
                                                    colorSquare.style.width = '12px';
                                                    colorSquare.style.height = '12px';
                                                    colorSquare.style.marginRight = '8px';
                                                    colorSquare.style.borderRadius = '2px';
                                                }
                                                // Also update the card's left border color
                                                const card = desc.closest('.border-l-4');
                                                if (card && !card.classList.contains('border-yellow-500')) {
                                                    // Remove default border color classes
                                                    card.classList.remove('border-indigo-500', 'border-gray-200');
                                                    card.style.borderLeftColor = color;
                                                }
                                            }
                                        }
                                    });
                                }

                                function updateTotalDuration() {
                                    const visibleAppointments = Array.from(document.querySelectorAll('#appointments-grid > div')).filter(
                                        appointment => {
                                            const isVisible = appointment.style.display !== 'none';
                                            const descTextEl = appointment.querySelector('.description-text');
                                            // Skip placeholder cards that don't have description-text
                                            if (!descTextEl) return false;
                                            const name = descTextEl.textContent.trim().toLowerCase();
                                            // More comprehensive break check
                                            const isBreak = name.includes('temps de pause repas') ||
                                                          name.includes('pause') ||
                                                          name.includes('repas');
                                            return isVisible && !isBreak;
                                        }
                                    );

                                    let totalMinutes = 0;
                                    visibleAppointments.forEach(appointment => {
                                        if (appointment.dataset.start && appointment.dataset.end) {
                                            const [startHour, startMin] = appointment.dataset.start.split(':').map(Number);
                                            const [endHour, endMin] = appointment.dataset.end.split(':').map(Number);

                                            // Calculate duration in minutes
                                            let startMinutes = startHour * 60 + startMin;
                                            let endMinutes = endHour * 60 + endMin;
                                            if (endMinutes < startMinutes) {  // Handle overnight shifts
                                                endMinutes += 24 * 60;
                                            }
                                            totalMinutes += endMinutes - startMinutes;
                                        } else {
                                            // Fallback for legacy (supports both English and French keywords)
                                            const timeText = appointment.querySelector('p:last-child').textContent;
                                            const timeMatch = timeText.match(/(?:from|de)\s+(\d{2}):(\d{2})\s+(?:to|à)\s+(\d{2}):(\d{2})/);
                                            if (timeMatch) {
                                                const startHour = parseInt(timeMatch[1]);
                                                const startMin = parseInt(timeMatch[2]);
                                                const endHour = parseInt(timeMatch[3]);
                                                const endMin = parseInt(timeMatch[4]);

                                                // Calculate duration in minutes
                                                let startMinutes = startHour * 60 + startMin;
                                                let endMinutes = endHour * 60 + endMin;
                                                if (endMinutes < startMinutes) {  // Handle overnight shifts
                                                    endMinutes += 24 * 60;
                                                }
                                                totalMinutes += endMinutes - startMinutes;
                                            }
                                        }
                                    });

                                    const hours = Math.floor(totalMinutes / 60);
                                    const minutes = totalMinutes % 60;
                                    const title = document.getElementById('appointments-title');
                                    // Use Django template tags to generate localized strings for JS
                                    const pendingText = "{% trans 'Pending Appointments' %}";
                                    title.innerHTML = `<span class="font-bold">${pendingText}</span> <span class="text-sm text-gray-600">({{ current_month_name }} {{ current_year }} ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')})</span>`;
                                }

                                // Function to initialize event filters
                                function initializeEventFilters() {
                                    const appointments = document.querySelectorAll('#appointments-grid > div');
                                    const nameStats = new Map();

                                    appointments.forEach(appointment => {
                                        const descTextEl = appointment.querySelector('.description-text');
                                        // Skip placeholder cards that don't have description-text
                                        if (!descTextEl) return;

                                        const fullName = descTextEl.textContent.trim();
                                        // More comprehensive break check
                                        if (fullName.toLowerCase().includes('temps de pause repas') ||
                                            fullName.toLowerCase().includes('pause') ||
                                            fullName.includes('repas')) {
                                            return;
                                        }
                                        // Extract base name without time information
                                        const baseName = fullName.split('(')[0].trim();

                                        if (!nameStats.has(baseName)) {
                                            nameStats.set(baseName, { count: 0, totalMinutes: 0 });
                                        }

                                        const stats = nameStats.get(baseName);
                                        stats.count++;

                                        // Extract start and end times
                                        if (appointment.dataset.start && appointment.dataset.end) {
                                            const [startHour, startMin] = appointment.dataset.start.split(':').map(Number);
                                            const [endHour, endMin] = appointment.dataset.end.split(':').map(Number);

                                            // Calculate duration in minutes
                                            let startMinutes = startHour * 60 + startMin;
                                            let endMinutes = endHour * 60 + endMin;
                                            if (endMinutes < startMinutes) {  // Handle overnight shifts
                                                endMinutes += 24 * 60;
                                            }
                                            stats.totalMinutes += endMinutes - startMinutes;
                                        } else {
                                            // Fallback for legacy (supports both English and French keywords)
                                            const timeText = appointment.querySelector('p:last-child').textContent;
                                            const timeMatch = timeText.match(/(?:from|de)\s+(\d{2}):(\d{2})\s+(?:to|à)\s+(\d{2}):(\d{2})/);
                                            if (timeMatch) {
                                                const startHour = parseInt(timeMatch[1]);
                                                const startMin = parseInt(timeMatch[2]);
                                                const endHour = parseInt(timeMatch[3]);
                                                const endMin = parseInt(timeMatch[4]);

                                                // Calculate duration in minutes
                                                let startMinutes = startHour * 60 + startMin;
                                                let endMinutes = endHour * 60 + endMin;
                                                if (endMinutes < startMinutes) {  // Handle overnight shifts
                                                    endMinutes += 24 * 60;
                                                }
                                                stats.totalMinutes += endMinutes - startMinutes;
                                            }
                                        }
                                    });

                                    // Create filter buttons
                                    const filterContainer = document.getElementById('event-filters');
                                    filterContainer.innerHTML = '';

                                    nameStats.forEach((stats, baseName) => {
                                        const hours = Math.floor(stats.totalMinutes / 60);
                                        const minutes = stats.totalMinutes % 60;
                                        const duration = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

                                        // Calculate average duration per count
                                        const avgMinutes = stats.count > 0 ? stats.totalMinutes / stats.count : 0;
                                        const avgHours = Math.floor(avgMinutes / 60);
                                        const avgMins = Math.round(avgMinutes % 60);
                                        const avgDuration = `${avgHours.toString().padStart(2, '0')}:${avgMins.toString().padStart(2, '0')}`;

                                        const button = document.createElement('button');
                                        button.className = 'flex items-center gap-2 text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors';

                                        const colorSquare = document.createElement('span');
                                        colorSquare.className = 'inline-block w-3 h-3 rounded';
                                        colorSquare.style.backgroundColor = getColorForName(baseName);

                                        const text = document.createElement('span');
                                        text.textContent = `${baseName} (${duration}) (${stats.count}) (${avgDuration})`;

                                        button.appendChild(colorSquare);
                                        button.appendChild(text);

                                        button.addEventListener('click', () => filterAppointments(baseName));
                                        filterContainer.appendChild(button);
                                    });

                                    // Show all button functionality
                                    document.getElementById('show-all-events').addEventListener('click', () => filterAppointments(null));
                                }

                                function updateShowAllButton() {
                                    const appointments = document.querySelectorAll('#appointments-grid > div');
                                    let totalCount = 0;

                                    appointments.forEach(appointment => {
                                        const descTextEl = appointment.querySelector('.description-text');
                                        // Skip placeholder cards that don't have description-text
                                        if (!descTextEl) return;
                                        const name = descTextEl.textContent.trim().toLowerCase();
                                        // More comprehensive break check
                                        if (!name.includes('pause') &&
                                            !name.includes('repas') &&
                                            !name.includes('temps de pause repas')) {
                                            totalCount++;
                                        }
                                    });

                                    const showAllButton = document.getElementById('show-all-events');
                                    const showAllText = "{% trans 'Show All' %}";
                                    showAllButton.textContent = `${showAllText} ${totalCount}`;
                                }

                                // Function to filter appointments
                                function filterAppointments(filterName) {
                                    const appointments = document.querySelectorAll('#appointments-grid > div');
                                    const showAllButton = document.getElementById('show-all-events');

                                    appointments.forEach(appointment => {
                                        const descTextEl = appointment.querySelector('.description-text');
                                        // Skip placeholder cards - always show them
                                        if (!descTextEl) {
                                            appointment.style.display = '';
                                            return;
                                        }
                                        const fullName = descTextEl.textContent.trim();
                                        const baseName = fullName.split('(')[0].trim();
                                        if (!filterName || baseName === filterName) {
                                            appointment.style.display = '';
                                        } else {
                                            appointment.style.display = 'none';
                                        }
                                    });

                                    // Update total duration after filtering
                                    updateTotalDuration();

                                    // Show/hide Show All button based on active filter
                                    if (filterName) {
                                        showAllButton.classList.remove('hidden');
                                    } else {
                                        showAllButton.classList.add('hidden');
                                    }

                                    // Update filter button styles
                                    const filterButtons = document.querySelectorAll('#event-filters button');
                                    filterButtons.forEach(button => {
                                        const buttonText = button.querySelector('span:last-child').textContent;
                                        const buttonName = buttonText.split(' (')[0];  // Get name part before first parenthesis
                                        if (buttonName === filterName) {
                                            button.classList.add('bg-gray-300');
                                            button.classList.remove('bg-gray-100');
                                        } else {
                                            button.classList.remove('bg-gray-300');
                                            button.classList.add('bg-gray-100');
                                        }
                                    });
                                }

                                // Function to rearrange appointments into AM/PM columns
                                function rearrangeAppointmentsToAmPmColumns() {
                                    const grid = document.getElementById('appointments-grid');
                                    if (!grid) return;

                                    const appointments = Array.from(grid.querySelectorAll(':scope > div'));
                                    if (appointments.length === 0) return;

                                    // Parse appointments and group by day
                                    const dayGroups = new Map(); // key: day number, value: { am: [], pm: [] }

                                    appointments.forEach(card => {
                                        // Use data attributes if available (robust), otherwise fallback to regex (fragile but legacy compatible)
                                        let day, startHour;
                                        
                                        if (card.dataset.day && card.dataset.start) {
                                            day = parseInt(card.dataset.day);
                                            const startParts = card.dataset.start.split(':');
                                            startHour = parseInt(startParts[0]);
                                        } else {
                                            // Fallback for legacy or untagged cards (supports both English and French keywords)
                                            const timeText = card.querySelector('p:last-child')?.textContent || '';
                                            const match = timeText.match(/(?:Day|Jour|Journée)\s+(\d+)\s+(?:from|de)\s+(\d{2}):(\d{2})\s+(?:to|à)/);
                                            if (!match) return; // Skip if we can't parse
                                            day = parseInt(match[1]);
                                            startHour = parseInt(match[2]);
                                        }

                                        if (!dayGroups.has(day)) {
                                            dayGroups.set(day, { am: [], pm: [] });
                                        }

                                        // AM = before 12:00 (hours 0-11), PM = 12:00 and after (hours 12-23)
                                        if (startHour < 12) {
                                            dayGroups.get(day).am.push(card);
                                        } else {
                                            dayGroups.get(day).pm.push(card);
                                        }
                                    });

                                    // Clear the grid
                                    grid.innerHTML = '';

                                    // Group localized strings for JS
                                    const labels = {
                                        day: "{% trans 'Day' %}",
                                        am: "{% trans 'AM' %}",
                                        pm: "{% trans 'PM' %}"
                                    };

                                    // Helper to create placeholder
                                    function createPlaceholder(day, slot) {
                                        const placeholder = document.createElement('div');
                                        placeholder.className = 'border-l-4 border-gray-200 bg-gray-50 rounded-lg shadow-sm p-3 opacity-50';
                                        placeholder.innerHTML = `
                                            <div class="flex items-center justify-center h-full min-h-[60px]">
                                                <p class="text-sm text-gray-400"></p>
                                            </div>
                                        `;
                                        return placeholder;
                                    }

                                    // Sort days and render in AM/PM pairs
                                    const sortedDays = Array.from(dayGroups.keys()).sort((a, b) => a - b);

                                    sortedDays.forEach(day => {
                                        const { am, pm } = dayGroups.get(day);
                                        const maxSlots = Math.max(am.length, pm.length, 1);

                                        for (let i = 0; i < maxSlots; i++) {
                                            // AM slot (even column)
                                            if (am[i]) {
                                                grid.appendChild(am[i]);
                                            } else {
                                                grid.appendChild(createPlaceholder(day, 'AM'));
                                            }

                                            // PM slot (odd column)
                                            if (pm[i]) {
                                                grid.appendChild(pm[i]);
                                            } else {
                                                grid.appendChild(createPlaceholder(day, 'PM'));
                                            }
                                        }
                                    });

                                }

                                // Initialize all components when the DOM is loaded
                                document.addEventListener('DOMContentLoaded', function() {
                                    rearrangeAppointmentsToAmPmColumns();  // Rearrange first
                                    updateAppointmentColors();
                                    updateShowAllButton();
                                    initializeEventFilters();
                                    updateTotalDuration();  // Calculate initial duration
                                });
                            </script>
                        {% else %}
                            <div class="text-center text-gray-600 py-8">
                                <p>{% trans "No appointments to display yet. Upload a PDF or paste schedule text above." %}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock content %}

{% block extra_js %}
    <script src="{% static 'js/calendar_progress.js' %}"></script>
    <script>
        // Initialize Google Sign-In
        function initializeGoogleSignIn() {
            const container = document.getElementById('google-signin-button');
            if (!container) {
                return;
            }

            const signInButton = container.querySelector('button');
            if (!signInButton) {
                console.warn('Google Sign-In: Button element not found within container');
                return;
            }

            console.warn('Google Sign-In: Initialized');

            const handleSignIn = function(e) {
                if (e) e.preventDefault();
                console.warn('Google Sign-In: Click detected');
                
                const clientId = '{{ google_oauth2_client_id }}';
                const redirectUri = '{{ google_oauth2_redirect_uri }}';
                const scope = '{{ oauth_scopes_string }}';
                const state = '{{ oauth_state }}';

                console.warn('Google Sign-In: Redirecting...', { clientId, redirectUri });

                if (!clientId || clientId === 'None') {
                    alert('Google OAuth Client ID is missing. Check your .env file.');
                    return;
                }

                const oauthUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
                oauthUrl.searchParams.append('client_id', clientId);
                oauthUrl.searchParams.append('redirect_uri', redirectUri);
                oauthUrl.searchParams.append('response_type', 'code');
                oauthUrl.searchParams.append('scope', scope);
                oauthUrl.searchParams.append('access_type', 'offline');
                oauthUrl.searchParams.append('prompt', 'consent');
                oauthUrl.searchParams.append('state', state);

                window.location.href = oauthUrl.toString();
            };

            // Attach to both button and container just in case
            signInButton.onclick = handleSignIn;
            container.onclick = handleSignIn;
            
            console.warn('Google Sign-In: Listeners attached');
        }

        // Initialize when the document is loaded
        if (document.readyState === 'complete') {
            initializeGoogleSignIn();
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                initializeGoogleSignIn();
            });
        }
    </script>
{% endblock extra_js %}

{% if user.is_authenticated %}
<script>
    // Ensure the fixed layout works correctly (relaxed: no hard height, keep navbar padding)
    document.addEventListener('DOMContentLoaded', function() {
        const fixedLayoutContainer = document.getElementById('fixed-layout-container');

        if (fixedLayoutContainer) {
            // Hide the main container's padding and the footer
            const mainContainer = document.getElementById('main-container');
            const mainFooter = document.getElementById('main-footer');

            if (mainContainer) {
                mainContainer.style.padding = '0';
                mainContainer.style.margin = '0';
                mainContainer.style.maxWidth = 'none';
                mainContainer.style.width = '100%';
            }

            if (mainFooter) {
                mainFooter.style.display = 'none';
            }

            // Maintain top padding for fixed navbar
            const nav = document.querySelector('nav');
            const navHeight = nav ? nav.offsetHeight : 64;
            document.body.style.paddingTop = navHeight + 'px';
        }
    });
</script>
{% endif %}
